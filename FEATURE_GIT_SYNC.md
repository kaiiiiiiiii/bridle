# Git Sync Feature

## Summary

Add git sync capability to Bridle so config changes auto-commit to a git repository, providing version history and disaster recovery without manual effort.

## Motivation

- **Multi-machine sync**: Keep AI assistant configs consistent across work/personal machines
- **Version history**: Roll back to previous configs after bad changes
- **Disaster recovery**: Restore configs on new machines with a single command
- **Team sharing**: Share curated profiles/MCP configs with teammates

## Architecture

```
~/.config/bridle/
â”œâ”€â”€ .git/                    # Git repository at config root
â”œâ”€â”€ config.toml              # Main bridle config
â”œâ”€â”€ profiles/                # All profiles
â”‚   â”œâ”€â”€ opencode/
â”‚   â”œâ”€â”€ claude-code/
â”‚   â””â”€â”€ goose/
â””â”€â”€ .gitignore               # Auto-generated
```

## Config Changes

```toml
[git_sync]
enabled = true
auto_commit = true           # Auto-stage on bridle changes
conflict_strategy = "abort"  # "abort", "ours", "theirs", "merge"

[git_remote]
url = "https://github.com/user/bridle-configs"
branch = "main"
```

## CLI Commands

| Command | Description |
|---------|-------------|
| `bridle git init [--remote <url>]` | Initialize git, optionally link remote |
| `bridle git clone <url>` | Clone config repo into ~/.config/bridle |
| `bridle git status` | Show staged/committed/pushed status |
| `bridle git commit [-m "msg"]` | Commit staged changes |
| `bridle git push` | Push to remote |
| `bridle git pull` | Pull from remote |
| `bridle git sync` | Pull â†’ commit staged â†’ push |
| `bridle git dry-run` | Show what WOULD happen |
| `bridle git unlink` | Remove remote, keep local |
| `bridle git credential set` | Store PAT in OS keychain |
| `bridle git credential remove` | Remove stored credential |

## Module Structure

```
src/
â”œâ”€â”€ git/
â”‚   â”œâ”€â”€ mod.rs                 # Public API
â”‚   â”œâ”€â”€ runner.rs              # Git CLI invocation and output parsing
â”‚   â”œâ”€â”€ repo.rs                # Repository.init, clone, open
â”‚   â”œâ”€â”€ operations.rs          # commit, push, pull, status
â”‚   â”œâ”€â”€ auth.rs                # Credential handling via keyring crate
â”‚   â”œâ”€â”€ conflict.rs            # Conflict detection/resolution
â”‚   â””â”€â”€ ignore.rs              # Generate .gitignore
```

## Auto-Commit on Bridle Changes

When Bridle modifies configs (profile switch, install, config set):
1. Changes are auto-staged (if `auto_commit = true`)
2. User can run `bridle git sync` or `bridle git commit` manually
3. Staged files accumulate until committed

**Affected operations:**
- `profile switch`
- `profile create-from-current`
- `config set`
- `install/uninstall` commands
- `init`

## Credential Management

| Method | Priority | Storage |
|--------|----------|---------|
| `keyring` crate | 1st | OS-native (Keychain/CredMan/SecretService) |
| Git credential helper | 2nd | Fallback if configured globally in git |
| SSH keys | Manual | Managed by system SSH agent (if using SSH remote) |

## Default .gitignore

```
# Generated by bridle-git-sync
# Secrets and environment files
**/mcp/*/env.json
**/.env
**/.env.*
**/secrets.*
*.pem
*.key

# OS files
.DS_Store
Thumbs.db

# Bridle internal
.backups/
.bridle-manifest.json
```

## Security Considerations

1. **Never commit secrets**: The .gitignore patterns above prevent common secret files
2. **Pre-commit scan**: Check for patterns like `sk-`, `ghp_`, `-----BEGIN` before commit
3. **Private repos recommended**: Prompt users to use private repositories
4. **Keyring isolation**: Credentials stored per-remote URL to avoid cross-contamination

## Conflict Resolution

```
1. git pull --rebase (default)
2. If conflict:
   - Abort and report conflicting files
   - User resolves with:
     - `bridle git merge`       # Merge commit
     - `bridle git discard`     # Keep remote, discard local
     - `bridle git force-push`  # Overwrite remote
```

### Machine-Specific Configs

For settings that should differ per machine (e.g., paths), consider:
- A `.bridle-local.toml` file that's gitignored
- Or use environment variables in config values (future enhancement)

## Git Installation Check

### Runtime Requirement

Git sync requires Git to be installed on the system. Bridle uses the system Git CLI for all operations.

### Installation Instructions

**macOS:**
```bash
# Using Homebrew (recommended)
brew install git

# Or using Xcode command line tools
xcode-select --install
```

**Linux (Debian/Ubuntu):**
```bash
sudo apt update && sudo apt install git
```

**Linux (Fedora):**
```bash
sudo dnf install git
```

**Windows:**
```bash
# Using Chocolatey
choco install git

# Or download from https://git-scm.com/download/win
```

### Error Handling

When Git is not installed, Bridle provides a helpful error message:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸  Git Not Found                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Git is required for the git sync feature but is not installed on your     â”‚
â”‚  system.                                                                    â”‚
â”‚                                                                             â”‚
â”‚  Please install Git to enable git sync:                                     â”‚
â”‚                                                                             â”‚
â”‚  macOS:    brew install git           (or xcode-select --install)           â”‚
â”‚  Linux:    sudo apt install git       (or dnf install git)                  â”‚
â”‚  Windows:  choco install git          (or download from git-scm.com)        â”‚
â”‚                                                                             â”‚
â”‚  After installation, restart Bridle to use git sync.                        â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Enter] Dismiss                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CLI Error Output:**
```
Error: git sync requires Git to be installed

Git is not installed or not in your PATH.

To install Git:
  macOS:    brew install git or xcode-select --install
  Linux:    sudo apt install git (Debian/Ubuntu)
            sudo dnf install git (Fedora)
  Windows:  choco install git or download from https://git-scm.com/download/win

Once installed, run 'bridle git init' to set up git sync.
```

## TUI Integration

### Status Bar Indicators

The git sync status appears in the main TUI status bar:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bridle v0.2.5                              Profile: claude-code  [ğŸŒ synced]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Indicator | Meaning |
|-----------|---------|
| `[ğŸŒ synced]` | All changes committed and pushed |
| `[ğŸ“ 2 staged]` | 2 files staged, not yet committed |
| `[ğŸ“¤ 3 unpushed]` | 3 commits waiting to push |
| `[ğŸ“¥ 1 behind]` | Remote has 1 commit we don't have |
| `[âš ï¸ conflict]` | Merge conflict needs resolution |
| `[âš¡ no remote]` | Git initialized but no remote configured |
| `[â”€ disabled]` | Git sync is disabled |

### Sync Tab Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Profiles  â”‚  MCP Servers  â”‚  Config  â”‚ â–¶ Sync                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Local Changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ Remote â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                      â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚  Staged (2 files)                    â”‚  â”‚  origin/main                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ profiles/claude-code/mcp.json   â”‚  â”‚  https://github.com/user/... â”‚ â”‚
â”‚  â”‚  â””â”€â”€ config.toml                     â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚                                      â”‚  â”‚  âœ“ Up to date                â”‚ â”‚
â”‚  â”‚  Unstaged (1 file)                   â”‚  â”‚    Last sync: 2 hours ago    â”‚ â”‚
â”‚  â”‚  â””â”€â”€ profiles/opencode/settings.json â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚                                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Unpushed Commits (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  a1b2c3d  Update MCP servers for claude-code          5 minutes ago  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [S]ync All   [C]ommit   [P]ush   Pu[l]l   [D]iff   [R]evert   [?] Help     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sync Tab Sections

| Section | Content |
|---------|---------|
| **Local Changes** | Staged and unstaged files with paths |
| **Remote** | Remote URL, branch, sync status |
| **Unpushed Commits** | List of local commits not yet pushed |
| **Action Bar** | Keyboard shortcuts for common operations |

### Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `S` | Sync All (pull â†’ commit â†’ push) |
| `C` | Commit staged changes (opens message input) |
| `P` | Push to remote |
| `L` | Pull from remote |
| `D` | Show diff of selected file |
| `A` | Stage/unstage selected file |
| `R` | Revert selected file |
| `?` | Show help overlay |
| `â†‘/â†“` | Navigate file list |
| `Enter` | View file details |

### Commit Message Input

When pressing `C` to commit:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Commit Changes                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Staged files (2):                                                          â”‚
â”‚    â€¢ profiles/claude-code/mcp.json                                          â”‚
â”‚    â€¢ config.toml                                                            â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Commit Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Update claude-code MCP configurationâ–ˆ                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  Suggestions: (Tab to use)                                                  â”‚
â”‚    â€¢ "Update claude-code profile"                                           â”‚
â”‚    â€¢ "Sync config changes"                                                  â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Enter] Commit    [Esc] Cancel                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Conflict Resolution View

When conflicts are detected:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸  Merge Conflict Detected                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Conflicting files (1):                                                     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ profiles/claude-code/mcp.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  <<<<<<< HEAD (local)                                                â”‚   â”‚
â”‚  â”‚    "filesystem": { "roots": ["/Users/kai"] }                         â”‚   â”‚
â”‚  â”‚  =======                                                             â”‚   â”‚
â”‚  â”‚    "filesystem": { "roots": ["/home/kai"] }                          â”‚   â”‚
â”‚  â”‚  >>>>>>> origin/main (remote)                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  Resolution options:                                                        â”‚
â”‚    [L] Keep Local (this machine's version)                                  â”‚
â”‚    [R] Keep Remote (other machine's version)                                â”‚
â”‚    [E] Edit manually (opens in $EDITOR)                                     â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [L] Local   [R] Remote   [E] Edit   [Esc] Abort                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Setup Wizard Flow

First-time setup when user enables git sync:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Git Sync Setup (1/4)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ”„ Sync your Bridle configs across machines                                â”‚
â”‚                                                                             â”‚
â”‚  Git sync will:                                                             â”‚
â”‚    â€¢ Track changes to profiles and settings                                 â”‚
â”‚    â€¢ Push configs to a remote repository                                    â”‚
â”‚    â€¢ Pull updates from other machines                                       â”‚
â”‚                                                                             â”‚
â”‚  How would you like to start?                                               â”‚
â”‚                                                                             â”‚
â”‚    â–¶ [N] New repository     Create a fresh config repository               â”‚
â”‚      [C] Clone existing     I have a bridle-configs repo already            â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [N] New   [C] Clone   [Esc] Cancel                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Git Sync Setup (2/4)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Enter your repository URL:                                                 â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ https://github.com/username/bridle-configsâ–ˆ                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  ğŸ’¡ Tip: Create a PRIVATE repository on GitHub, GitLab, etc.                â”‚
â”‚         Your configs may contain sensitive paths or settings.               â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Enter] Continue   [Esc] Back                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Git Sync Setup (3/4)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ” Authentication                                                          â”‚
â”‚                                                                             â”‚
â”‚  Enter your Personal Access Token (PAT):                                    â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â–ˆ                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  ğŸ“‹ How to create a PAT:                                                    â”‚
â”‚     GitHub: Settings â†’ Developer settings â†’ Personal access tokens          â”‚
â”‚     Required scope: "repo" (full control of private repositories)           â”‚
â”‚                                                                             â”‚
â”‚  âœ“ Token will be stored securely in your OS keychain                        â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Enter] Save & Test   [Esc] Back                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Git Sync Setup (4/4)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âœ… Setup Complete!                                                         â”‚
â”‚                                                                             â”‚
â”‚  Repository: https://github.com/username/bridle-configs                     â”‚
â”‚  Branch: main                                                               â”‚
â”‚  Auto-commit: enabled                                                       â”‚
â”‚                                                                             â”‚
â”‚  Initial commit will include:                                               â”‚
â”‚    â€¢ config.toml                                                            â”‚
â”‚    â€¢ profiles/claude-code/                                                  â”‚
â”‚    â€¢ profiles/opencode/                                                     â”‚
â”‚    â€¢ .gitignore (auto-generated)                                            â”‚
â”‚                                                                             â”‚
â”‚  Excluded (see .gitignore):                                                 â”‚
â”‚    â€¢ **/mcp/*/env.json                                                      â”‚
â”‚    â€¢ **/.env, secrets.*, *.pem                                              â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Enter] Create Initial Commit   [Esc] Cancel                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dependencies

```toml
keyring = { version = "3.6", features = ["apple-native", "windows-native", "sync-secret-service"] }
dirs = "6.0"            # Standard config directory discovery
tempfile = "3.10"       # For test fixtures
```

### Why These Choices

**Shelling out to git CLI instead of git2:**
- Git is universally available on developer machines
- Avoids bundling a large C library (libgit2) in the binary
- Benefits from user's configured git (aliases, prompts, diff tools)
- Easier SSH configuration (uses existing SSH agent and configs)
- Simpler maintenance (no C-bindings or platform-specific compilation)

**keyring for credentials:**
- Native OS integration (Keychain, Credential Manager, Secret Service)
- No separate credential file to manage
- Users' existing PATs/tokens from other tools may already be stored

## Implementation Details

### Git CLI Runner

All git operations use `Command::new("git")` with proper error handling:

```rust
use std::process::Command;

pub struct GitRunner {
    working_dir: PathBuf,
}

impl GitRunner {
    pub fn new(working_dir: impl Into<PathBuf>) -> Self {
        Self {
            working_dir: working_dir.into(),
        }
    }

    pub fn git_available() -> bool {
        Command::new("git")
            .arg("--version")
            .output()
            .map(|o| o.status.success())
            .unwrap_or(false)
    }

    pub fn run(&self, args: &[&str]) -> Result<GitOutput, GitError> {
        let output = Command::new("git")
            .args(args)
            .current_dir(&self.working_dir)
            .output()
            .map_err(GitError::Io)?;

        if !output.status.success() {
            return Err(GitError::CommandFailed(
                output.stderr_string_lossy(),
                output.status.code(),
            ));
        }

        Ok(GitOutput {
            stdout: output.stdout,
            stderr: output.stderr,
        })
    }
}
```

### Git Command Implementation

```rust
impl GitRepo {
    pub fn init(&self, remote: Option<&str>) -> Result<(), GitError> {
        self.runner.run(&["init"])?;

        if let Some(url) = remote {
            self.runner.run(&["remote", "add", "origin", url])?;
        }

        self.generate_gitignore()?;
        self.initial_commit()
    }

    pub fn clone(&self, url: &str) -> Result<(), GitError> {
        self.runner.run(&["clone", url, "."])?;
        self.generate_gitignore()
    }

    pub fn commit(&self, message: &str) -> Result<(), GitError> {
        self.runner.run(&["commit", "-m", message])?;
        Ok(())
    }

    pub fn push(&self, remote: &str, branch: &str) -> Result<(), GitError> {
        self.runner.run(&["push", remote, branch])?;
        Ok(())
    }

    pub fn pull(&self, remote: &str, branch: &str) -> Result<(), GitError> {
        self.runner.run(&["pull", "--rebase", remote, branch])?;
        Ok(())
    }

    pub fn status(&self) -> Result<GitStatus, GitError> {
        let output = self.runner.run(&["status", "--porcelain"])?;
        let staged = self.runner.run(&["diff", "--staged", "--name-only"])?;
        let unpushed = self.runner.run(&["log", "@{u}..HEAD", "--oneline"])?;
        Ok(GitStatus {
            porcelain: output.stdout_string_lossy(),
            staged_files: staged.stdout_string_lossy(),
            unpushed_count: unpushed.lines().count(),
        })
    }
}
```

### Credential Management

Instead of custom providers, we leverage the OS native stores via `keyring` crate:
* **macOS:** Keychain
* **Windows:** Credential Manager
* **Linux:** Secret Service API (GNOME Keyring / KWallet)

**Storage key format:** `bridle-git:<remote-url>` with username as the account name.

**Auth with Git:**
```rust
fn configure_credential_helper(remote_url: &str, token: &str) {
    let cred_helper = format!(
        "!f() {{ echo \"username={}\"; echo \"password={}\"; }}; f",
        "git", // username for PAT auth
        token
    );

    Command::new("git")
        .args(&[
            "config", "--global",
            &format!("credential.https://github.com.helper"),
            &cred_helper,
        ])
        .output();
}
```

### Conflict Resolution Strategies

Expanded strategies for config management:
* **abort** (Default): Stop if upstream has changes that conflict.
* **theirs-force**: "I want my other machine's config" (reset --hard origin/main).
* **ours-force**: "This machine is the source of truth" (force push).
* **autostash**: Stash local changes -> pull --rebase -> stash pop.

### Pre-Commit Validation

Before auto-committing, Bridle should:
1. Validate TOML syntax of changed files.
2. Ensure no secrets are being committed (basic heuristic check for patterns like `sk-`, `ghp_`, API key formats).
3. Verify .gitignore patterns are applied.

### Error Types

```rust
#[derive(Debug, thiserror::Error)]
pub enum GitError {
    #[error("Git is not installed or not in PATH")]
    GitNotInstalled,

    #[error("Git command failed: {0}")]
    CommandFailed(String, Option<i32>),

    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),

    #[error("Repository not found at {0}")]
    RepoNotFound(PathBuf),

    #[error("Remote not configured: {0}")]
    NoRemote(String),

    #[error("Authentication failed: {0}")]
    AuthFailed(String),

    #[error("Merge conflict detected: {0}")]
    Conflict(String),

    #[error("Network error: {0}")]
    Network(String),
}
```

## Implementation Phases

### Phase 1: Foundation
- [ ] `git init --remote` / `git clone` commands
- [ ] Basic commit/push/pull operations via CLI
- [ ] Auth with credential helper
- [ ] Generate .gitignore
- [ ] Git installation check with helpful error messages

### Phase 2: Integration
- [ ] Auto-stage on Bridle config changes
- [ ] TUI status indicator
- [ ] Setup wizard

### Phase 3: Polish
- [ ] Dry-run mode
- [ ] Conflict resolution flow
- [ ] Status tab in TUI

## Simplified Flow

```
User makes change via Bridle
        â†“
Bridle auto-stages (if auto_commit = true)
        â†“
User runs: bridle git sync
        â†“
Pull â†’ Commit staged â†’ Push
        â†“
Done
```

## Error Handling

| Error | User Message | Recovery |
|-------|--------------|----------|
| Git not installed | "Git is required. Install via: brew install git (macOS), apt install git (Linux), or download from git-scm.com" | Show install instructions |
| No remote configured | "Run `bridle git init --remote <url>` first" | Guide to setup |
| Auth failed | "Credential invalid. Run `bridle git credential set`" | Re-auth |
| Conflict on pull | "Conflicts in: file.toml. Run `bridle git status`" | Show resolution options |
| Push rejected | "Remote has changes. Run `bridle git pull` first" | Pull then retry |
| Network unreachable | "Cannot reach remote. Changes saved locally." | Retry later |

## Testing Strategy

### Mock Git Runner

For testing without requiring actual git installation:

```rust
#[cfg(test)]
mod mocks {
    use super::*;

    pub struct MockGitRunner {
        outputs: HashMap<Vec<&'static str>, &'static str>,
        call_count: HashMap<Vec<&'static str>, usize>,
    }

    impl MockGitRunner {
        pub fn new() -> Self {
            let mut outputs = HashMap::new();

            outputs.insert(vec!["--version"], "git version 2.40.0");
            outputs.insert(vec!["status", "--porcelain"], "");
            outputs.insert(vec!["diff", "--staged", "--name-only"], "");
            outputs.insert(vec!["log", "@{u}..HEAD", "--oneline"], "");

            Self {
                outputs,
                call_count: HashMap::new(),
            }
        }

        pub fn expect(&mut self, args: &[&'static str], output: &'static str) {
            self.outputs.insert(args.to_vec(), output);
        }

        pub fn run(&mut self, args: &[&str]) -> Result<GitOutput, GitError> {
            let key = args.to_vec();
            let count = self.call_count.entry(key.clone()).or_insert(0);
            *count += 1;

            if let Some(output) = self.outputs.get(&key) {
                Ok(GitOutput {
                    stdout: output.as_bytes().to_vec(),
                    stderr: Vec::new(),
                })
            } else {
                Err(GitError::CommandFailed(
                    format!("Unexpected git command: {:?}", args),
                    Some(1),
                ))
            }
        }
    }

    #[test]
    fn test_git_status_empty() {
        let mut runner = MockGitRunner::new();
        runner.expect(&["status", "--porcelain"], "");
        runner.expect(&["diff", "--staged", "--name-only"], "");
        runner.expect(&["log", "@{u}..HEAD", "--oneline"], "");

        let status = runner.run(&["status", "--porcelain"]).unwrap();
        assert!(status.stdout.is_empty());
    }

    #[test]
    fn test_git_status_with_changes() {
        let mut runner = MockGitRunner::new();
        runner.expect(
            &["status", "--porcelain"],
            " M config.toml\n M profiles/opencode/settings.json",
        );
        runner.expect(&["diff", "--staged", "--name-only"], " M config.toml");
        runner.expect(&["log", "@{u}..HEAD", "--oneline"], "");

        let status = runner.run(&["status", "--porcelain"]).unwrap();
        assert!(!status.stdout.is_empty());
    }
}
```

### TUI Mock for Testing

```rust
#[cfg(test)]
mod tui_mocks {
    use super::*;

    pub struct MockTui {
        messages: Vec<String>,
        prompts: Vec<String>,
        confirmations: Vec<bool>,
    }

    impl MockTui {
        pub fn new() -> Self {
            Self {
                messages: Vec::new(),
                prompts: Vec::new(),
                confirmations: Vec::new(),
            }
        }

        pub fn show_message(&mut self, msg: &str) {
            self.messages.push(msg.to_string());
        }

        pub fn prompt_input(&mut self, prompt: &str) -> String {
            self.prompts.push(prompt.to_string());
            String::new()
        }

        pub fn confirm(&mut self, prompt: &str) -> bool {
            self.confirmations.push(prompt.to_string());
            true
        }
    }

    #[test]
    fn test_setup_wizard_prompts() {
        let mut tui = MockTui::new();

        // Simulate setup wizard flow
        tui.show_message("Git Sync Setup");
        let choice = tui.prompt_input("How would you like to start?");
        assert_eq!(choice, "");

        let remote = tui.prompt_input("Enter repository URL");
        assert!(tui.messages.contains(&"Git Sync Setup".to_string()));
    }
}
```

### Integration Test Fixtures

```rust
#[cfg(test)]
mod integration_tests {
    use super::*;
    use tempfile::TempDir;

    fn create_test_repo() -> (TempDir, GitRepo) {
        let temp_dir = TempDir::new().unwrap();
        let git_repo = GitRepo::new(temp_dir.path());

        // Initialize with real git for integration testing
        std::process::Command::new("git")
            .args(&["init"])
            .current_dir(temp_dir.path())
            .output()
            .unwrap();

        (temp_dir, git_repo)
    }

    #[test]
    fn test_init_creates_git_repo() {
        let (_temp, repo) = create_test_repo();
        assert!(repo.path().join(".git").exists());
    }

    #[test]
    fn test_commit_creates_history() {
        let (temp, repo) = create_test_repo();

        let config_path = temp.path().join("config.toml");
        std::fs::write(&config_path, "test = true").unwrap();

        repo.add(&["config.toml"]).unwrap();
        repo.commit("Initial commit").unwrap();

        let log_output = std::process::Command::new("git")
            .args(&["log", "--oneline"])
            .current_dir(temp.path())
            .output()
            .unwrap();

        assert!(log_output.status.success());
        assert!(String::from_utf8_lossy(&log_output.stdout)
            .contains("Initial commit"));
    }
}
```

### Test Categories

1. **Unit tests**: Mock GitRunner for all operations
2. **Integration tests**: Use temp directories with real git repos
3. **CLI tests**: Test git commands via `assert_cmd` crate
4. **Credential tests**: Test against mock keyring (feature flag for testing)
5. **TUI tests**: Use ratatui testing framework for component tests
